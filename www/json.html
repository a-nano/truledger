<html>
<head>
  <link rel='stylesheet' type='text/css' href='css/docstyle.css'>
  <link rel='stylesheet' type='text/css' href='css/tables.css'>
  <title>Truledger JSON Client Sandbox</title>
  <style>th { text-align: right; }</style>
  <script src='css/jquery-1.7.2.min.js'></script>
  <script>
function send(obj, processor) {
    obj = JSON.stringify(obj);
    $('#sent').val(obj);
    $.post('json/', {'eval':obj}, function(data) {
        $('#rcvd').val(JSON.stringify(data));
        if (data && typeof(data)=='object' && data['@type']=='error') {
            $('#error').text(data['message']);
        } else {
            $('#error').html('&nbsp;');
            processor(data);
        }
    }, 'JSON');
}

function ignore(data) {
}

function hide(cls, obj) {
    if ($(obj).text().trim() == 'Hide') {
        $('.'+cls).hide();
        $(obj).text('Show');
    } else {
        $('.'+cls).show();
        $(obj).text('Hide');
    }        
}

var session;
function returnSession(data) {
    session = data;
    $('#session').text(session);
}
function login() {
  passphrase = $('#passphrase').val();
  send(['login',{'passphrase':passphrase}], returnSession);
}

function notLoggedIn() {
    $('#sent').val('');
    $('#rcvd').val('');
    $('#error').text('Not logged in');
}

function logout() {
    if (session) {
        send(['logout',{'session':session}],ignore);
        session = false;
        $('#session').text('None');
        $('#currentuser').val('');
    } else {
        notLoggedIn();
    }
}

function getuser() {
    if (session) {
        send(['current-user',{'session':session}], function(data) {
            $('#currentuser').val(data);
        });
    } else {
        notLoggedIn();
    }
}

function getpubkey() {
    if (session) {
        send(['getpubkey',{'session':session}], function(data) {
            $('#pubkey').val(data);
        });
    } else {
        notLoggedIn();
    }
}

function currentserver() {
    if (session) {
        send(['current-server',{'session':session}], function(data) {
            $('#server').val(data);
        });
    } else {
        notLoggedIn();
    }
}

function returnPrivkey(data) {
    $('#privkey').val(data);
}

function getprivkey() {
    passphrase = $('#passphrase').val();
    send(['getprivkey',{'passphrase':passphrase}],
         returnPrivkey);
}

function newuser() {
    passphrase = $('#passphrase').val();
    keysize = $('#keysize').val();
    name = $('#name').val();
    url = $('#url').val();
    coupon = $('#coupon').val();
    proxy = $('#proxy').val();
    privkey = $('#privkey').val();
    if (privkey != '') keysize = null;
    send(['newuser',{'passphrase':passphrase,
                     'keysize':keysize,
                     'name':name,
                     'url':url,
                     'coupon':coupon,
                     'proxy':proxy,
                     'privkey':privkey,}],
         returnSession);
}

function useCachedPrivkey() {
    passphrase = $('#passphrase').val();
    url = $('#url').val();
    proxy = $('#proxy').val();
    send(['newuser',{'passphrase':passphrase,
                     'fetch-privkey?':true,
                     'url':url,
                     'proxy':proxy}],
         returnSession);
}

function getserver() {
    serverid = $('#server').val();
    if (session) {
        send(['getserver',{'session':session,
                           'serverid':serverid}],
             function(data) {
                 showServers([data]);
             });             
    } else {
        notLoggedIn();
    }
}

function getservers() {
    serverid = $('#server').val();
    if (session) {
        send(['getservers',{'session':session}], showServers);
    } else {
        notLoggedIn();
    }
}

function showServers(servers) {
    table = $('#servertable')[0];
    while (table.rows.length > 1) {
        table.deleteRow(1);
    }
    for (i=0; i<servers.length; i++) {
        server = servers[i];
        row = table.insertRow(-1);
        $(row.insertCell(0)).text(server.id);
        $(row.insertCell(1)).text(server.name);
        $(row.insertCell(2)).text(server.url);
        $(row.insertCell(3)).text(server.proxy);
    }
}
  </script>
</head>
<body onload='$("#passphrase").focus()'>
  <h2>Truledger JSON Client Sandbox</h2>
  <p>This page is for playing with the JSON interface to the Truledger client.</p>
  <table>
    <tr>
      <th>Sent:</th>
      <td>
        <textarea id='sent' name='sent' cols='80' rows='5'>JSON sent to the server goes here.</textarea>
      </td>
    </tr>
    <tr>
      <th>Received:</th>
      <td>
        <textarea id='rcvd' name='rcvd' cols='80' rows='10'>JSON returned by the server goes here.</textarea>
        </td>
    </tr>
    <tr>
      <th>&nbsp;</th>
      <td><span id='error' style='color: red;'>&nbsp;</span></td>
    </tr>
    <tr>
      <th>Session:</th>
      <td id='session'>None</td>
    </tr>
    <tr>
      <th>Current User:</th>
      <td>
        <input type='text' name='currentuser' id='currentuser' size='60'
               disabled='disabled'/>
        <input type='submit' name='getuser' value='Get Current User'
               onClick='getuser();'/>
      </td>
    </tr>
    <tr>
      <th>Passphrase:</th>
      <td>
        <input id='passphrase' name='passphrase' type='password' size='40'/>
        <input type='submit' name='login' value='Login' onClick='login();'/>
        <input type='submit' name='logout' value='Logout' onClick='logout();'/>
        <input type='submit' name='getprivkey' value="Get Privkey"
               onClick='getprivkey()'/>
      </td>
    </tr>
    <tr>
      <th>&nbsp;</th>
      <td>
        <a href='javascript:void(0)' onClick="javascript:hide('newuser',this)">
          Hide</a> New User fields
      </td>
    </tr>
    <tr class='newuser'>
      <th>URL:</th>
      <td><input id='url' name='url' type='text' size='40'/></td>
    </tr>
    <tr class='newuser'>
      <th>Proxy:</th>
      <td>
        <input id='proxy' name='proxy' type='text' size='40'/>
        <input type='submit' name='cachedprivkey' value='Use Cached Privkey'
               onClick='useCachedPrivkey()'/>
      </td>
    </tr>
    <tr class='newuser'>
      <th>Key Size:</th>
      <td>
        <select id='keysize' name='keysize'>
          <option value='512'>512</option>
          <option value='1024'>1024</option>
          <option value='2048'>2048</option>
          <option value='3072'>3072</option>
          <option value='4096'>4096</option>
        </select>
      </td>
    </tr>
    <tr class='newuser'>
      <th>Name:</th>
      <td><input id='name' name='name' type='text' size='30'/></td>
    </tr>
    <tr class='newuser'>
      <th>Coupon:</th>
      <td><input id='coupon' name='coupon' type='text' size='80'/></td>
    </tr>
    <tr class='newuser'>
      <th>Privkey:</th>
      <td><textarea id='privkey' cols='65' rows='10'></textarea></td>
    </tr>
    <tr class='newuser'>
      <td>&nbsp;</td>
      <td>
        <input type='submit' name='newuser' value='New User' onClick='newuser()'/>
      </td>
    </tr>
    <tr class='newuser'><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <th>Pubkey:</th>
      <td><textarea id='pubkey' cols='65' rows='10'></textarea></td>
    </tr>
    <tr>
      <td>&nbsp;</td>
      <td>
        <input type='submit' name='getpubkey' value='Get Pubkey'
               onClick='getpubkey();'/>
      </td>
    </tr>
    <tr><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <th>Server:</th>
      <td>
        <input type='text' name='server' id='server' size='60'/>
        <input type='submit' name='getserver' value='Get Server Info'
               onClick='getserver();'/>
        <input type='submit' name='currentserver' value='Get Current Server'
               onClick='currentserver();'/>
      </td>
    </tr>
    <tr>
      <th>Servers:</th>
      <td>
        <table class='prettytable' id='servertable'>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>URL</th>
            <th>Proxy</th>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td>&nbsp;</td>
      <td>
        <input type='submit' name='getservers' value='Get Servers'
               onClick='getservers()'/>
      </td>
    </tr>
  </table>
</body>
</html>
